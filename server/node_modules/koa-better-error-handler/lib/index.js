'use strict';

// initialize try/catch error handling right away
// adapted from: https://github.com/koajs/onerror/blob/master/index.js
// https://github.com/koajs/examples/issues/20#issuecomment-31568401
//
// inspired by:
// https://goo.gl/62oU7P
// https://goo.gl/8Z7aMe

// eslint-disable-next-line complexity
let errorHandler = (() => {
  var _ref = _asyncToGenerator(function* (err) {
    if (!err) return;

    if (!_.isError(err)) err = new Error(err);

    const type = this.accepts(['text', 'json', 'html']);

    if (!type) {
      debug('invalid type, sending 406 error');
      err.status = 406;
      err.message = Boom.notAcceptable().output.payload;
    }

    // parse mongoose validation errors
    err = parseValidationError(this, err);

    // check if we threw just a status code in order to keep it simple
    const val = parseInt(err.message, 10);
    if (_.isNumber(val) && val >= 400) err = Boom.create(val);

    // check if we have a boom error that specified
    // a status code already for us (and then use it)
    if (_.isObject(err.output) && _.isNumber(err.output.statusCode)) err.status = err.output.statusCode;

    if (!_.isNumber(err.status)) err.status = 500;

    // check if there is flash messaging
    const hasFlash = _.isFunction(this.flash);
    debug('hasFlash', hasFlash);

    // check if there is session support
    const hasSessions = _.isObject(this.session) && _.isObject(this.sessionStore) && _.isString(this.sessionId) && _.isObject(this.session) && _.isFunction(this.sessionStore.set);
    debug('hasSessions', hasSessions);

    // check if there is a view rendering engine binding `this.render`
    const hasRender = _.isFunction(this.render);
    debug('hasRender', hasRender);

    // check if we're about to go into a possible endless redirect loop
    const noReferrer = this.get('Referrer') === '';

    // nothing we can do here other
    // than delegate to the app-level
    // handler and log.
    if (this.headerSent || !this.writable) {
      debug('headers were already sent, returning early');
      err.headerSent = true;
      return;
    }

    // populate the status and body with `boom` error message payload
    // (e.g. you can do `ctx.throw(404)` and it will output a beautiful err obj)
    err.status = err.status || 500;
    err.statusCode = err.status;
    this.statusCode = err.statusCode;
    this.status = this.statusCode;
    this.body = Boom.create(err.status, err.message).output.payload;

    debug('status code was %d', this.status);

    this.app.emit('error', err, this);

    // fix page title and description
    this.state.meta = this.state.meta || {};
    this.state.meta.title = this.body.error;
    this.state.meta.description = err.message;
    debug('set `this.state.meta.title` to %s', this.state.meta.title);
    debug('set `this.state.meta.desc` to %s', this.state.meta.description);

    debug('type was %s', type);

    switch (type) {
      case 'html':
        this.type = 'html';

        if (this.status === 404) {
          // render the 404 page
          // https://github.com/koajs/koa/issues/646
          if (hasRender) {
            try {
              debug('rendering 404 page');
              yield this.render('404');
            } catch (err) {
              debug('could not find 404 page, using built-in 404 html');
              this.body = _404;
            }
          } else {
            this.body = _404;
          }
        } else if (noReferrer || this.status === 500) {
          // this prevents a redirect loop by detecting an empty Referrer
          // ...otherwise it would reach the next conditional block which
          // would endlessly rediret the user with `this.redirect('back')`
          if (noReferrer) debug('prevented endless redirect loop!');

          // flash an error message
          if (hasFlash) this.flash('error', err.message);

          // render the 500 page
          if (hasRender) {
            try {
              debug('rendering 500 page');
              yield this.render('500');
            } catch (err) {
              debug('could not find 500 page, using built-in 500 html');
              this.body = _500;
            }
          } else {
            this.body = _500;
          }
        } else {
          // flash an error message
          if (hasFlash) this.flash('error', err.message);

          // TODO: until the issue is resolved, we need to add this here
          // <https://github.com/koajs/generic-session/pull/95#issuecomment-246308544>
          if (this.sessionStore && this.sessionId && this.session && this.state.cookiesKey) {
            yield co.wrap(this.sessionStore.set).call(this.sessionStore, this.sessionId, this.session);
            this.cookies.set(this.state.cookiesKey, this.sessionId, this.session.cookie);
          }

          /*
          // if we're using `koa-session-store` we need to add
          // `this._session = new Session()`, and then run this:
          await co.wrap(this._session._store.save).call(
            this._session._store,
            this._session._sid,
            JSON.stringify(this.session)
          );
          this.cookies.set(this._session._name, JSON.stringify({
            _sid: this._session._sid
          }), this._session._cookieOpts);
          */

          // redirect the user to the page they were just on
          this.redirect('back');
        }
        break;
      case 'json':
        this.type = 'json';
        this.body = JSON.stringify(this.body, null, 2);
        break;
      default:
        this.type = 'text';
        this.body = JSON.stringify(this.body, null, 2);
        break;
    }

    this.length = Buffer.byteLength(this.body);
    this.res.end(this.body);
  });

  return function errorHandler(_x) {
    return _ref.apply(this, arguments);
  };
})();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const fs = require('fs');
const path = require('path');
const s = require('underscore.string');
const co = require('co');
const Debug = require('debug');
const _ = require('lodash');
const Boom = require('boom');

const opts = {
  encoding: 'utf8'
};

// error pages were inspired by HTML5 Boilerplate's default 404.html page
// https://github.com/h5bp/html5-boilerplate/blob/master/src/404.html
const _404 = fs.readFileSync(path.join(__dirname, '..', '404.html'), opts);
const _500 = fs.readFileSync(path.join(__dirname, '..', '500.html'), opts);

const debug = new Debug('koa-better-error-handler');

function parseValidationError(ctx, err) {
  // inspired by https://github.com/syntagma/mongoose-error-helper
  if (err.name !== 'ValidationError') return err;

  // transform the error messages to be humanized as adapted from:
  // https://github.com/niftylettuce/mongoose-validation-error-transform
  err.errors = _.map(err.errors, error => {
    if (!_.isString(error.path)) {
      error.message = s.capitalize(error.message);
      return error;
    }
    error.message = error.message.replace(new RegExp(error.path, 'g'), s.humanize(error.path));
    error.message = s.capitalize(error.message);
    return error;
  });

  // loop over the errors object of the Validation Error
  // with support for HTML error lists
  if (_.values(err.errors).length === 1) {
    err.message = _.values(err.errors)[0].message;
  } else {
    const errors = _.map(_.values(err.errors), 'message');
    err.message = ctx.api ? errors.join(', ') : `<ul class="text-xs-left mb-0"><li>${errors.join('</li><li>')}</li></ul>`;
  }

  return err;
}

module.exports = errorHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJlcnIiLCJfIiwiaXNFcnJvciIsIkVycm9yIiwidHlwZSIsImFjY2VwdHMiLCJkZWJ1ZyIsInN0YXR1cyIsIm1lc3NhZ2UiLCJCb29tIiwibm90QWNjZXB0YWJsZSIsIm91dHB1dCIsInBheWxvYWQiLCJwYXJzZVZhbGlkYXRpb25FcnJvciIsInZhbCIsInBhcnNlSW50IiwiaXNOdW1iZXIiLCJjcmVhdGUiLCJpc09iamVjdCIsInN0YXR1c0NvZGUiLCJoYXNGbGFzaCIsImlzRnVuY3Rpb24iLCJmbGFzaCIsImhhc1Nlc3Npb25zIiwic2Vzc2lvbiIsInNlc3Npb25TdG9yZSIsImlzU3RyaW5nIiwic2Vzc2lvbklkIiwic2V0IiwiaGFzUmVuZGVyIiwicmVuZGVyIiwibm9SZWZlcnJlciIsImdldCIsImhlYWRlclNlbnQiLCJ3cml0YWJsZSIsImJvZHkiLCJhcHAiLCJlbWl0Iiwic3RhdGUiLCJtZXRhIiwidGl0bGUiLCJlcnJvciIsImRlc2NyaXB0aW9uIiwiXzQwNCIsIl81MDAiLCJjb29raWVzS2V5IiwiY28iLCJ3cmFwIiwiY2FsbCIsImNvb2tpZXMiLCJjb29raWUiLCJyZWRpcmVjdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJsZW5ndGgiLCJCdWZmZXIiLCJieXRlTGVuZ3RoIiwicmVzIiwiZW5kIiwiZXJyb3JIYW5kbGVyIiwiZnMiLCJyZXF1aXJlIiwicGF0aCIsInMiLCJEZWJ1ZyIsIm9wdHMiLCJlbmNvZGluZyIsInJlYWRGaWxlU3luYyIsImpvaW4iLCJfX2Rpcm5hbWUiLCJjdHgiLCJuYW1lIiwiZXJyb3JzIiwibWFwIiwiY2FwaXRhbGl6ZSIsInJlcGxhY2UiLCJSZWdFeHAiLCJodW1hbml6ZSIsInZhbHVlcyIsImFwaSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBbUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOzsrQkFDQSxXQUE0QkEsR0FBNUIs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TixHQUFnQnVELEVBQUVXLFVBQUYsQ0FBYWpDLE1BQU1qQyxPQUFuQixDQUFoQjtBQUNBLGFBQU9pQyxLQUFQO0FBQ0Q7QUFDREEsVUFBTWpDLE9BQU4sR0FBZ0JpQyxNQUFNakMsT0FBTixDQUFjbUUsT0FBZCxDQUNkLElBQUlDLE1BQUosQ0FBV25DLE1BQU1xQixJQUFqQixFQUF1QixHQUF2QixDQURjLEVBRWRDLEVBQUVjLFFBQUYsQ0FBV3BDLE1BQU1xQixJQUFqQixDQUZjLENBQWhCO0FBSUFyQixVQUFNakMsT0FBTixHQUFnQnVELEVBQUVXLFVBQUYsQ0FBYWpDLE1BQU1qQyxPQUFuQixDQUFoQjtBQUNBLFdBQU9pQyxLQUFQO0FBQ0QsR0FYWSxDQUFiOztBQWFBO0FBQ0E7QUFDQSxNQUFJeEMsRUFBRTZFLE1BQUYsQ0FBUzlFLElBQUl3RSxNQUFiLEVBQXFCbEIsTUFBckIsS0FBZ0MsQ0FBcEMsRUFBdUM7QUFDckN0RCxRQUFJUSxPQUFKLEdBQWNQLEVBQUU2RSxNQUFGLENBQVM5RSxJQUFJd0UsTUFBYixFQUFxQixDQUFyQixFQUF3QmhFLE9BQXRDO0FBQ0QsR0FGRCxNQUVPO0FBQ0wsVUFBTWdFLFNBQVN2RSxFQUFFd0UsR0FBRixDQUFNeEUsRUFBRTZFLE1BQUYsQ0FBUzlFLElBQUl3RSxNQUFiLENBQU4sRUFBNEIsU0FBNUIsQ0FBZjtBQUNBeEUsUUFBSVEsT0FBSixHQUFjOEQsSUFBSVMsR0FBSixHQUNWUCxPQUFPSixJQUFQLENBQVksSUFBWixDQURVLEdBRVQscUNBQW9DSSxPQUFPSixJQUFQLENBQ25DLFdBRG1DLENBRW5DLFlBSk47QUFLRDs7QUFFRCxTQUFPcEUsR0FBUDtBQUNEOztBQUVEZ0YsT0FBT0MsT0FBUCxHQUFpQnRCLFlBQWpCIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHMgPSByZXF1aXJlKCd1bmRlcnNjb3JlLnN0cmluZycpO1xuY29uc3QgY28gPSByZXF1aXJlKCdjbycpO1xuY29uc3QgRGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpO1xuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuY29uc3QgQm9vbSA9IHJlcXVpcmUoJ2Jvb20nKTtcblxuY29uc3Qgb3B0cyA9IHtcbiAgZW5jb2Rpbmc6ICd1dGY4J1xufTtcblxuLy8gZXJyb3IgcGFnZXMgd2VyZSBpbnNwaXJlZCBieSBIVE1MNSBCb2lsZXJwbGF0ZSdzIGRlZmF1bHQgNDA0Lmh0bWwgcGFnZVxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2g1YnAvaHRtbDUtYm9pbGVycGxhdGUvYmxvYi9tYXN0ZXIvc3JjLzQwNC5odG1sXG5jb25zdCBfNDA0ID0gZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICc0MDQuaHRtbCcpLCBvcHRzKTtcbmNvbnN0IF81MDAgPSBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJzUwMC5odG1sJyksIG9wdHMpO1xuXG5jb25zdCBkZWJ1ZyA9IG5ldyBEZWJ1Zygna29hLWJldHRlci1lcnJvci1oYW5kbGVyJyk7XG5cbi8vIGluaXRpYWxpemUgdHJ5L2NhdGNoIGVycm9yIGhhbmRsaW5nIHJpZ2h0IGF3YXlcbi8vIGFkYXB0ZWQgZnJvbTogaHR0cHM6Ly9naXRodWIuY29tL2tvYWpzL29uZXJyb3IvYmxvYi9tYXN0ZXIvaW5kZXguanNcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9rb2Fqcy9leGFtcGxlcy9pc3N1ZXMvMjAjaXNzdWVjb21tZW50LTMxNTY4NDAxXG4vL1xuLy8gaW5zcGlyZWQgYnk6XG4vLyBodHRwczovL2dvby5nbC82Mm9VN1Bcbi8vIGh0dHBzOi8vZ29vLmdsLzhaN2FNZVxuXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgY29tcGxleGl0eVxuYXN5bmMgZnVuY3Rpb24gZXJyb3JIYW5kbGVyKGVycikge1xuICBpZiAoIWVycikgcmV0dXJuO1xuXG4gIGlmICghXy5pc0Vycm9yKGVycikpIGVyciA9IG5ldyBFcnJvcihlcnIpO1xuXG4gIGNvbnN0IHR5cGUgPSB0aGlzLmFjY2VwdHMoWyd0ZXh0JywgJ2pzb24nLCAnaHRtbCddKTtcblxuICBpZiAoIXR5cGUpIHtcbiAgICBkZWJ1ZygnaW52YWxpZCB0eXBlLCBzZW5kaW5nIDQwNiBlcnJvcicpO1xuICAgIGVyci5zdGF0dXMgPSA0MDY7XG4gICAgZXJyLm1lc3NhZ2UgPSBCb29tLm5vdEFjY2VwdGFibGUoKS5vdXRwdXQucGF5bG9hZDtcbiAgfVxuXG4gIC8vIHBhcnNlIG1vbmdvb3NlIHZhbGlkYXRpb24gZXJyb3JzXG4gIGVyciA9IHBhcnNlVmFsaWRhdGlvbkVycm9yKHRoaXMsIGVycik7XG5cbiAgLy8gY2hlY2sgaWYgd2UgdGhyZXcganVzdCBhIHN0YXR1cyBjb2RlIGluIG9yZGVyIHRvIGtlZXAgaXQgc2ltcGxlXG4gIGNvbnN0IHZhbCA9IHBhcnNlSW50KGVyci5tZXNzYWdlLCAxMCk7XG4gIGlmIChfLmlzTnVtYmVyKHZhbCkgJiYgdmFsID49IDQwMCkgZXJyID0gQm9vbS5jcmVhdGUodmFsKTtcblxuICAvLyBjaGVjayBpZiB3ZSBoYXZlIGEgYm9vbSBlcnJvciB0aGF0IHNwZWNpZmllZFxuICAvLyBhIHN0YXR1cyBjb2RlIGFscmVhZHkgZm9yIHVzIChhbmQgdGhlbiB1c2UgaXQpXG4gIGlmIChfLmlzT2JqZWN0KGVyci5vdXRwdXQpICYmIF8uaXNOdW1iZXIoZXJyLm91dHB1dC5zdGF0dXNDb2RlKSlcbiAgICBlcnIuc3RhdHVzID0gZXJyLm91dHB1dC5zdGF0dXNDb2RlO1xuXG4gIGlmICghXy5pc051bWJlcihlcnIuc3RhdHVzKSkgZXJyLnN0YXR1cyA9IDUwMDtcblxuICAvLyBjaGVjayBpZiB0aGVyZSBpcyBmbGFzaCBtZXNzYWdpbmdcbiAgY29uc3QgaGFzRmxhc2ggPSBfLmlzRnVuY3Rpb24odGhpcy5mbGFzaCk7XG4gIGRlYnVnKCdoYXNGbGFzaCcsIGhhc0ZsYXNoKTtcblxuICAvLyBjaGVjayBpZiB0aGVyZSBpcyBzZXNzaW9uIHN1cHBvcnRcbiAgY29uc3QgaGFzU2Vzc2lvbnMgPVxuICAgIF8uaXNPYmplY3QodGhpcy5zZXNzaW9uKSAmJlxuICAgIF8uaXNPYmplY3QodGhpcy5zZXNzaW9uU3RvcmUpICYmXG4gICAgXy5pc1N0cmluZyh0aGlzLnNlc3Npb25JZCkgJiZcbiAgICBfLmlzT2JqZWN0KHRoaXMuc2Vzc2lvbikgJiZcbiAgICBfLmlzRnVuY3Rpb24odGhpcy5zZXNzaW9uU3RvcmUuc2V0KTtcbiAgZGVidWcoJ2hhc1Nlc3Npb25zJywgaGFzU2Vzc2lvbnMpO1xuXG4gIC8vIGNoZWNrIGlmIHRoZXJlIGlzIGEgdmlldyByZW5kZXJpbmcgZW5naW5lIGJpbmRpbmcgYHRoaXMucmVuZGVyYFxuICBjb25zdCBoYXNSZW5kZXIgPSBfLmlzRnVuY3Rpb24odGhpcy5yZW5kZXIpO1xuICBkZWJ1ZygnaGFzUmVuZGVyJywgaGFzUmVuZGVyKTtcblxuICAvLyBjaGVjayBpZiB3ZSdyZSBhYm91dCB0byBnbyBpbnRvIGEgcG9zc2libGUgZW5kbGVzcyByZWRpcmVjdCBsb29wXG4gIGNvbnN0IG5vUmVmZXJyZXIgPSB0aGlzLmdldCgnUmVmZXJyZXInKSA9PT0gJyc7XG5cbiAgLy8gbm90aGluZyB3ZSBjYW4gZG8gaGVyZSBvdGhlclxuICAvLyB0aGFuIGRlbGVnYXRlIHRvIHRoZSBhcHAtbGV2ZWxcbiAgLy8gaGFuZGxlciBhbmQgbG9nLlxuICBpZiAodGhpcy5oZWFkZXJTZW50IHx8ICF0aGlzLndyaXRhYmxlKSB7XG4gICAgZGVidWcoJ2hlYWRlcnMgd2VyZSBhbHJlYWR5IHNlbnQsIHJldHVybmluZyBlYXJseScpO1xuICAgIGVyci5oZWFkZXJTZW50ID0gdHJ1ZTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBwb3B1bGF0ZSB0aGUgc3RhdHVzIGFuZCBib2R5IHdpdGggYGJvb21gIGVycm9yIG1lc3NhZ2UgcGF5bG9hZFxuICAvLyAoZS5nLiB5b3UgY2FuIGRvIGBjdHgudGhyb3coNDA0KWAgYW5kIGl0IHdpbGwgb3V0cHV0IGEgYmVhdXRpZnVsIGVyciBvYmopXG4gIGVyci5zdGF0dXMgPSBlcnIuc3RhdHVzIHx8IDUwMDtcbiAgZXJyLnN0YXR1c0NvZGUgPSBlcnIuc3RhdHVzO1xuICB0aGlzLnN0YXR1c0NvZGUgPSBlcnIuc3RhdHVzQ29kZTtcbiAgdGhpcy5zdGF0dXMgPSB0aGlzLnN0YXR1c0NvZGU7XG4gIHRoaXMuYm9keSA9IEJvb20uY3JlYXRlKGVyci5zdGF0dXMsIGVyci5tZXNzYWdlKS5vdXRwdXQucGF5bG9hZDtcblxuICBkZWJ1Zygnc3RhdHVzIGNvZGUgd2FzICVkJywgdGhpcy5zdGF0dXMpO1xuXG4gIHRoaXMuYXBwLmVtaXQoJ2Vycm9yJywgZXJyLCB0aGlzKTtcblxuICAvLyBmaXggcGFnZSB0aXRsZSBhbmQgZGVzY3JpcHRpb25cbiAgdGhpcy5zdGF0ZS5tZXRhID0gdGhpcy5zdGF0ZS5tZXRhIHx8IHt9O1xuICB0aGlzLnN0YXRlLm1ldGEudGl0bGUgPSB0aGlzLmJvZHkuZXJyb3I7XG4gIHRoaXMuc3RhdGUubWV0YS5kZXNjcmlwdGlvbiA9IGVyci5tZXNzYWdlO1xuICBkZWJ1Zygnc2V0IGB0aGlzLnN0YXRlLm1ldGEudGl0bGVgIHRvICVzJywgdGhpcy5zdGF0ZS5tZXRhLnRpdGxlKTtcbiAgZGVidWcoJ3NldCBgdGhpcy5zdGF0ZS5tZXRhLmRlc2NgIHRvICVzJywgdGhpcy5zdGF0ZS5tZXRhLmRlc2NyaXB0aW9uKTtcblxuICBkZWJ1ZygndHlwZSB3YXMgJXMnLCB0eXBlKTtcblxuICBzd2l0Y2ggKHR5cGUpIHtcbiAgICBjYXNlICdodG1sJzpcbiAgICAgIHRoaXMudHlwZSA9ICdodG1sJztcblxuICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSA0MDQpIHtcbiAgICAgICAgLy8gcmVuZGVyIHRoZSA0MDQgcGFnZVxuICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20va29hanMva29hL2lzc3Vlcy82NDZcbiAgICAgICAgaWYgKGhhc1JlbmRlcikge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBkZWJ1ZygncmVuZGVyaW5nIDQwNCBwYWdlJyk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnJlbmRlcignNDA0Jyk7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBkZWJ1ZygnY291bGQgbm90IGZpbmQgNDA0IHBhZ2UsIHVzaW5nIGJ1aWx0LWluIDQwNCBodG1sJyk7XG4gICAgICAgICAgICB0aGlzLmJvZHkgPSBfNDA0O1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLmJvZHkgPSBfNDA0O1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKG5vUmVmZXJyZXIgfHwgdGhpcy5zdGF0dXMgPT09IDUwMCkge1xuICAgICAgICAvLyB0aGlzIHByZXZlbnRzIGEgcmVkaXJlY3QgbG9vcCBieSBkZXRlY3RpbmcgYW4gZW1wdHkgUmVmZXJyZXJcbiAgICAgICAgLy8gLi4ub3RoZXJ3aXNlIGl0IHdvdWxkIHJlYWNoIHRoZSBuZXh0IGNvbmRpdGlvbmFsIGJsb2NrIHdoaWNoXG4gICAgICAgIC8vIHdvdWxkIGVuZGxlc3NseSByZWRpcmV0IHRoZSB1c2VyIHdpdGggYHRoaXMucmVkaXJlY3QoJ2JhY2snKWBcbiAgICAgICAgaWYgKG5vUmVmZXJyZXIpIGRlYnVnKCdwcmV2ZW50ZWQgZW5kbGVzcyByZWRpcmVjdCBsb29wIScpO1xuXG4gICAgICAgIC8vIGZsYXNoIGFuIGVycm9yIG1lc3NhZ2VcbiAgICAgICAgaWYgKGhhc0ZsYXNoKSB0aGlzLmZsYXNoKCdlcnJvcicsIGVyci5tZXNzYWdlKTtcblxuICAgICAgICAvLyByZW5kZXIgdGhlIDUwMCBwYWdlXG4gICAgICAgIGlmIChoYXNSZW5kZXIpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgZGVidWcoJ3JlbmRlcmluZyA1MDAgcGFnZScpO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZW5kZXIoJzUwMCcpO1xuICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgZGVidWcoJ2NvdWxkIG5vdCBmaW5kIDUwMCBwYWdlLCB1c2luZyBidWlsdC1pbiA1MDAgaHRtbCcpO1xuICAgICAgICAgICAgdGhpcy5ib2R5ID0gXzUwMDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5ib2R5ID0gXzUwMDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gZmxhc2ggYW4gZXJyb3IgbWVzc2FnZVxuICAgICAgICBpZiAoaGFzRmxhc2gpIHRoaXMuZmxhc2goJ2Vycm9yJywgZXJyLm1lc3NhZ2UpO1xuXG4gICAgICAgIC8vIFRPRE86IHVudGlsIHRoZSBpc3N1ZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0byBhZGQgdGhpcyBoZXJlXG4gICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20va29hanMvZ2VuZXJpYy1zZXNzaW9uL3B1bGwvOTUjaXNzdWVjb21tZW50LTI0NjMwODU0ND5cbiAgICAgICAgaWYgKFxuICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JlICYmXG4gICAgICAgICAgdGhpcy5zZXNzaW9uSWQgJiZcbiAgICAgICAgICB0aGlzLnNlc3Npb24gJiZcbiAgICAgICAgICB0aGlzLnN0YXRlLmNvb2tpZXNLZXlcbiAgICAgICAgKSB7XG4gICAgICAgICAgYXdhaXQgY29cbiAgICAgICAgICAgIC53cmFwKHRoaXMuc2Vzc2lvblN0b3JlLnNldClcbiAgICAgICAgICAgIC5jYWxsKHRoaXMuc2Vzc2lvblN0b3JlLCB0aGlzLnNlc3Npb25JZCwgdGhpcy5zZXNzaW9uKTtcbiAgICAgICAgICB0aGlzLmNvb2tpZXMuc2V0KFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5jb29raWVzS2V5LFxuICAgICAgICAgICAgdGhpcy5zZXNzaW9uSWQsXG4gICAgICAgICAgICB0aGlzLnNlc3Npb24uY29va2llXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qXG4gICAgICAgIC8vIGlmIHdlJ3JlIHVzaW5nIGBrb2Etc2Vzc2lvbi1zdG9yZWAgd2UgbmVlZCB0byBhZGRcbiAgICAgICAgLy8gYHRoaXMuX3Nlc3Npb24gPSBuZXcgU2Vzc2lvbigpYCwgYW5kIHRoZW4gcnVuIHRoaXM6XG4gICAgICAgIGF3YWl0IGNvLndyYXAodGhpcy5fc2Vzc2lvbi5fc3RvcmUuc2F2ZSkuY2FsbChcbiAgICAgICAgICB0aGlzLl9zZXNzaW9uLl9zdG9yZSxcbiAgICAgICAgICB0aGlzLl9zZXNzaW9uLl9zaWQsXG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXNzaW9uKVxuICAgICAgICApO1xuICAgICAgICB0aGlzLmNvb2tpZXMuc2V0KHRoaXMuX3Nlc3Npb24uX25hbWUsIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBfc2lkOiB0aGlzLl9zZXNzaW9uLl9zaWRcbiAgICAgICAgfSksIHRoaXMuX3Nlc3Npb24uX2Nvb2tpZU9wdHMpO1xuICAgICAgICAqL1xuXG4gICAgICAgIC8vIHJlZGlyZWN0IHRoZSB1c2VyIHRvIHRoZSBwYWdlIHRoZXkgd2VyZSBqdXN0IG9uXG4gICAgICAgIHRoaXMucmVkaXJlY3QoJ2JhY2snKTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ2pzb24nOlxuICAgICAgdGhpcy50eXBlID0gJ2pzb24nO1xuICAgICAgdGhpcy5ib2R5ID0gSlNPTi5zdHJpbmdpZnkodGhpcy5ib2R5LCBudWxsLCAyKTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aGlzLnR5cGUgPSAndGV4dCc7XG4gICAgICB0aGlzLmJvZHkgPSBKU09OLnN0cmluZ2lmeSh0aGlzLmJvZHksIG51bGwsIDIpO1xuICAgICAgYnJlYWs7XG4gIH1cblxuICB0aGlzLmxlbmd0aCA9IEJ1ZmZlci5ieXRlTGVuZ3RoKHRoaXMuYm9keSk7XG4gIHRoaXMucmVzLmVuZCh0aGlzLmJvZHkpO1xufVxuXG5mdW5jdGlvbiBwYXJzZVZhbGlkYXRpb25FcnJvcihjdHgsIGVycikge1xuICAvLyBpbnNwaXJlZCBieSBodHRwczovL2dpdGh1Yi5jb20vc3ludGFnbWEvbW9uZ29vc2UtZXJyb3ItaGVscGVyXG4gIGlmIChlcnIubmFtZSAhPT0gJ1ZhbGlkYXRpb25FcnJvcicpIHJldHVybiBlcnI7XG5cbiAgLy8gdHJhbnNmb3JtIHRoZSBlcnJvciBtZXNzYWdlcyB0byBiZSBodW1hbml6ZWQgYXMgYWRhcHRlZCBmcm9tOlxuICAvLyBodHRwczovL2dpdGh1Yi5jb20vbmlmdHlsZXR0dWNlL21vbmdvb3NlLXZhbGlkYXRpb24tZXJyb3ItdHJhbnNmb3JtXG4gIGVyci5lcnJvcnMgPSBfLm1hcChlcnIuZXJyb3JzLCBlcnJvciA9PiB7XG4gICAgaWYgKCFfLmlzU3RyaW5nKGVycm9yLnBhdGgpKSB7XG4gICAgICBlcnJvci5tZXNzYWdlID0gcy5jYXBpdGFsaXplKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIGVycm9yO1xuICAgIH1cbiAgICBlcnJvci5tZXNzYWdlID0gZXJyb3IubWVzc2FnZS5yZXBsYWNlKFxuICAgICAgbmV3IFJlZ0V4cChlcnJvci5wYXRoLCAnZycpLFxuICAgICAgcy5odW1hbml6ZShlcnJvci5wYXRoKVxuICAgICk7XG4gICAgZXJyb3IubWVzc2FnZSA9IHMuY2FwaXRhbGl6ZShlcnJvci5tZXNzYWdlKTtcbiAgICByZXR1cm4gZXJyb3I7XG4gIH0pO1xuXG4gIC8vIGxvb3Agb3ZlciB0aGUgZXJyb3JzIG9iamVjdCBvZiB0aGUgVmFsaWRhdGlvbiBFcnJvclxuICAvLyB3aXRoIHN1cHBvcnQgZm9yIEhUTUwgZXJyb3IgbGlzdHNcbiAgaWYgKF8udmFsdWVzKGVyci5lcnJvcnMpLmxlbmd0aCA9PT0gMSkge1xuICAgIGVyci5tZXNzYWdlID0gXy52YWx1ZXMoZXJyLmVycm9ycylbMF0ubWVzc2FnZTtcbiAgfSBlbHNlIHtcbiAgICBjb25zdCBlcnJvcnMgPSBfLm1hcChfLnZhbHVlcyhlcnIuZXJyb3JzKSwgJ21lc3NhZ2UnKTtcbiAgICBlcnIubWVzc2FnZSA9IGN0eC5hcGlcbiAgICAgID8gZXJyb3JzLmpvaW4oJywgJylcbiAgICAgIDogYDx1bCBjbGFzcz1cInRleHQteHMtbGVmdCBtYi0wXCI+PGxpPiR7ZXJyb3JzLmpvaW4oXG4gICAgICAgICAgJzwvbGk+PGxpPidcbiAgICAgICAgKX08L2xpPjwvdWw+YDtcbiAgfVxuXG4gIHJldHVybiBlcnI7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZXJyb3JIYW5kbGVyO1xuIl19